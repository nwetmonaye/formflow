rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Forms - users can only access their own forms
    match /forms/{formId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.createdBy;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.createdBy;
      // Allow public read access for form submission (without auth)
      allow read: if resource.data.isPublic == true;
    }
    
    // Submissions - form owners can read all submissions for their forms, submitters can read their own
    match /submissions/{submissionId} {
      allow read, write: if request.auth != null && 
        (request.auth.uid == resource.data.submitterId || 
         request.auth.uid == get(/databases/$(database)/documents/forms/$(resource.data.formId)).data.createdBy);
      allow create: if request.auth != null || 
        (request.auth == null && 
         get(/databases/$(database)/documents/forms/$(resource.data.formId)).data.isPublic == true);
    }
    
    // Notifications - users can only access their own notifications
    match /notifications/{notificationId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null;
    }
    
    // Form Links - form owners can manage their form links
    match /formLinks/{linkId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.createdBy;
      allow read: if request.auth != null && resource.data.isPublic == true;
    }
    
    // Email Logs - only system can write, users can read their own
    match /emailLogs/{logId} {
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.userId || 
         request.auth.uid == get(/databases/$(database)/documents/forms/$(resource.data.formId)).data.createdBy);
      allow write: if false; // Only functions can write
    }
    
    // User Profiles - users can read/write their own profile
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Public form submissions (for anonymous users)
    match /publicSubmissions/{submissionId} {
      allow create: if true; // Allow anonymous submissions
      allow read: if request.auth != null && 
        request.auth.uid == get(/databases/$(database)/documents/forms/$(resource.data.formId)).data.createdBy;
    }
  }
} 